$(function(){$(document).on("click","#seRemoveUpdateBtn",function(){const e=$("#fileList");window._lastTrackListData&&s(e,window._lastTrackListData)}),$(document).on("change","#repeatNotationCheckbox",function(){const e=this.checked?"withRepeatNotation":"none";window._repeatNotation=e;const t=$("#fileList");window._lastTrackListData&&s(t,window._lastTrackListData)}),$(document).on("input","#repeatThreshold",function(){const e=$("#fileList");window._lastTrackListData&&s(e,window._lastTrackListData)}),$(".numbering-row, .ext-row, .repeat-row, .se-remove-row, .time-format-row").hide(),$("#toggleOptions").on("click",function(){$(".numbering-row, .ext-row, .repeat-row, .se-remove-row, .time-format-row").each(function(){$(this).slideToggle(300)})}),$(document).on("click","#copyTs",function(){const e=o(),t=[];if(window._lastRenderedList&&window._lastRenderedList.length>0&&window._lastRenderedList.forEach((n,a)=>{const i=n.displayName&&String(n.displayName)?n.displayName:(n.filename||"").split(/[/\\]/).pop(),o=c(n.tlBegin);"head"===e?t.push(`${a+1} ${o} ${i}`):"beforeName"===e?t.push(`${o} ${a+1} ${i}`):t.push(`${o} ${i}`)}),0===t.length){const n=$("#fileList li:not(.header)");if(0===n.length)return void alert("コピーするタイムスタンプがありません");n.each(function(n){const a=$(this).find(".ts").text(),i=$(this).find(".name").text();"head"===e?t.push(`${n+1} ${a} ${i}`):"beforeName"===e?t.push(`${a} ${n+1} ${i}`):t.push(`${a} ${i}`)})}const n=$("#copyHeaderSelect").val();let a=t.join("\n");if(n&&"none"!==n){let e="";n.startsWith("fixed:")&&(e=n.replace("fixed:","")),e&&(a=`${e}\n${a}`)}navigator.clipboard.writeText(a).then(()=>{alert("タイムスタンプをコピーしました")})}),$(document).on("change",'input[name="extOption"]',function(){const e=$("#fileList");window._lastTrackListData&&s(e,window._lastTrackListData)});const e=$("#fileInput");function t(e){const t=Object.keys(e.files).find(e=>e.endsWith("timeline.wesproj"));t?e.files[t].async("string").then(n):alert("timeline.wesproj ファイルがzip内に見つかりません")}function n(e){const t=$("#fileList");t.empty();const n=o(),s=window._repeatNotation||"none";t.append(l(n));try{const o=JSON.parse(e),l=[];if(p(o,l),l.length>0){l.sort((e,t)=>{const n=Number(e.tlBegin),a=Number(t.tlBegin);return isNaN(n)||isNaN(a)?0:n-a});const e=$('input[name="extOption"]:checked').val();l.forEach(t=>{"none"===e&&(t.filename=t.filename.replace(/(\.mp3|\.wav|\.m4a)$/i,""))}),window._lastTrackListData=l;let o=a(l,s),r=0;o.forEach(e=>{t.append(i(e,r,n,s)),r+=e.repeatCount})}else t.append("<li>filenameとtlBeginが見つかりませんでした。</li>")}catch(e){t.append("<li>JSONのパースに失敗しました。</li>")}}function a(e,t){if("withRepeatNotation"===t){const t=Number($("#repeatThreshold").val())||10;let n=!1;return e.map((e,a)=>a+1<t?{...e,isRepeat:!1,isVisible:!0}:n?{...e,isRepeat:!0,isVisible:!1}:(n=!0,{...e,isRepeat:!0,isVisible:!0}))}return e.map(e=>({...e,isRepeat:!1,isVisible:!0}))}function i(e,t,n,a){const i=document.createElement("li");i.classList.add("data-row");const o=document.createElement("span");o.className="num";const s=document.createElement("span");s.className="ts";const l=document.createElement("span");l.className="name",o.textContent=t+1,s.textContent=c(e.tlBegin);let p=r(e.filename);return"withRepeatNotation"===a&&e.isRepeat&&(p="Repeat"),l.textContent=p,i.dataset.filename=e.filename,"head"===n?i.append(o,s,l):"beforeName"===n?i.append(s,o,l):i.append(s,l),i}function o(){const e=document.querySelector('input[name="numbering"]:checked');return e?e.value:"none"}function s(e,t){const n=o(),s=window._repeatNotation||"none",c=$('input[name="extOption"]:checked').val(),p=Number($("#seRemoveSecound").val())||0;e.empty(),e.append(l(n));let d=t.map(e=>{let t=(e.originalFilename||e.filename).split(/[/\\]/).pop();return"none"===c&&(t=t.replace(/(\.mp3|\.wav|\.m4a)$/i,"")),{...e,filename:t}}),m=d;p>0&&(m=d.filter(e=>{let t=null;return"number"!=typeof e.duration||isNaN(e.duration)||(t=e.duration/1e7),!(null!==t&&t<=p)}));let u=a(m,s),f=0;const h=[];u.forEach(t=>{if(!1!==t.isVisible){const a="withRepeatNotation"===s&&t.isRepeat?"Repeat":r(t.filename);e.append(i(t,f,n,s)),h.push({filename:t.filename,tlBegin:t.tlBegin,displayName:a}),f++}}),window._lastRenderedList=h}function l(e){return"head"===e?'<li class="header"><span class="num">No</span><span class="ts">開始時間</span><span class="name">ファイル名</span></li>':"beforeName"===e?'<li class="header"><span class="ts">開始時間</span><span class="num">No</span><span class="name">ファイル名</span></li>':'<li class="header"><span class="ts">開始時間</span><span class="name">ファイル名</span></li>'}function r(e){return"string"!=typeof e?e:e.split(/[/\\]/).pop()}function c(e){const t=Number(e);if(isNaN(t))return e;let n=Math.floor(t/1e7);const a=function(){const e=document.querySelector('input[name="timeFormat"]:checked');return e?e.value:"h:m:ss"}(),i=Math.floor(n/3600),o=Math.floor(n%3600/60),s=n%60;return"[h:]m:ss"===a?0===i?`${o}:${s.toString().padStart(2,"0")}`:`${i}:${o.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`:`${i.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}function p(e,t){if(null==e||"object"!=typeof e)return;if("filename"in e&&"tlBegin"in e&&"string"==typeof e.filename&&(e.filename.toLowerCase().endsWith(".mp3")||e.filename.toLowerCase().endsWith(".wav")||e.filename.toLowerCase().endsWith(".m4a"))){let n=null;"tlEnd"in e&&void 0!==e.tlEnd&&(n=Number(e.tlEnd)-Number(e.tlBegin)),t.push({filename:e.filename,originalFilename:e.filename,tlBegin:e.tlBegin,duration:n})}for(const n in e)p(e[n],t)}0!==e.length&&(e.on("change",function(e){const n=e.target.files[0];n&&(n.name.endsWith(".wfp")?function(e){const n=new FileReader;n.onload=function(e){JSZip.loadAsync(e.target.result).then(t)},n.readAsArrayBuffer(e)}(n):alert("WFPファイルを選択してください"))}),$(document).on("change",'input[name="numbering"]',function(){const e=$("#fileList");window._lastTrackListData&&s(e,window._lastTrackListData)}),$(document).on("change",'input[name="timeFormat"]',function(){const e=$("#fileList");window._lastTrackListData&&s(e,window._lastTrackListData)}))});